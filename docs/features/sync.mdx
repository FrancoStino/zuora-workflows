---
title: Workflow Synchronization
description: Complete system for synchronizing Zuora workflows and tasks
---
# Zuora Workflow and Task Synchronization System

## Architecture

### Previous Problem
- Workflows were retrieved **via API every time** in the `CustomerWorkflows.php` page
- No Customer-Workflow relationship in the database
- Manual and global sync without per-customer separation
- No workflow task management

### Implemented Solution
1. **Database Relationship**: Customer hasMany Workflow hasMany Task with FK
2. **Sync Service**: `WorkflowSyncService` handles Zuora API pagination and task extraction
3. **Async Job**: `SyncCustomerWorkflows` for background processing with retry logic
4. **Scheduler**: Configurable synchronization via Laravel Scheduler (routes/console.php)
5. **Local Query**: UI reads directly from database (fast)
6. **Task Management**: Automatic task extraction from workflow JSON
7. **Job Monitoring**: Moox Jobs integration for real-time monitoring

## Synchronization Flow

```
1. Trigger Synchronization
   ├─ Customer Save (Filament UI) → afterCreate()
   ├─ Click "Sync Customer" / "Sync All Customers" button
   ├─ CLI Command: php artisan app:sync-workflows --all
   └─ Automatic Scheduler (if enabled in routes/console.php)
   ↓
2. SyncCustomerWorkflows::dispatch() → Job queued
   ↓
3. Job in queue (database)
   ↓
4. Queue Worker processes job (lando queue / cron schedule:run)
   ↓
5. WorkflowSyncService::syncCustomerWorkflows()
   ├─ Page 1 → HTTP GET /workflows?page=1&page_length=50
   ├─ Page 2 → HTTP GET /workflows?page=2&page_length=50
   ├─ ... (until hasMore=false)
   ├─ For each workflow:
   │  ├─ Download JSON export: GET /workflows/{id}/export
   │  ├─ Save/Update workflow in DB
   │  └─ Workflow->syncTasksFromJson() → Extracts and saves tasks
   └─ Delete stale workflows (no longer in Zuora)
   ↓
6. Database updated (workflows + tasks)
   ↓
7. Filament UI shows updated data (instant)
   ↓
8. Moox Jobs: Real-time monitoring
```

## Usage

### Via Filament Interface (Recommended)

1. **Single customer sync:**
   - Go to **Workflows** in the sidebar
   - Click on **Sync Customer**
   - Select the customer from the dropdown
   - Click on **Queue Sync**
   - The job is queued immediately

2. **Sync all customers:**
   - Go to **Workflows** in the sidebar
   - Click on **Sync All Customers**
   - Confirm the action
   - All jobs are queued

3. **Monitoring:**
   - Go to **Jobs** menu in the sidebar
   - View **Jobs** (completed/running)
   - View **Jobs Waiting** (in queue)
   - View **Failed Jobs** (failed with retry)

### CLI Commands

#### Workflow Synchronization

```bash
# Queue job for a customer
php artisan app:sync-workflows --customer="MyCustomer"

# Queue job for all customers
php artisan app:sync-workflows --all

# Synchronous execution (no queue - for debugging)
php artisan app:sync-workflows --all --sync
```

#### Task Synchronization (Rarely Needed)

Tasks are automatically extracted during workflow synchronization. Use these commands only if:
- You manually modified a workflow's JSON
- You want to re-extract tasks without downloading from Zuora

```bash
# Re-extract tasks from all workflows
php artisan workflows:sync-tasks --all

# Re-extract tasks from a specific workflow
php artisan workflows:sync-tasks --workflow-id=123
```

### Automatic Sync (Configurable)

In `routes/console.php` (Laravel 12):

```php
// Uncomment to enable automatic sync
Schedule::command('app:sync-workflows --all')
    ->hourly()  // Every hour (recommended)
    // ->daily()   // Once a day
    // ->everyFiveMinutes()  // Every 5 minutes (for testing)
    ->name('sync-customer-workflows');
```

**Setup Required:**
- **Development:** `lando schedule` (keep terminal open)
- **Production:** Cron job `* * * * * php artisan schedule:run` (see DEPLOYMENT.md)

## Queue Configuration

### Local Development (Lando)

1. **Configure `.env`:**
```env
QUEUE_CONNECTION=database
```

2. **Start queue worker:**
```bash
lando queue
# Or: lando artisan queue:work database --tries=3 --timeout=300
```

3. **[Optional] Start scheduler for automatic sync:**
```bash
lando schedule
# Or: lando artisan schedule:work
```

### Production

1. **Queue connection** (already configured from deploy):
```env
QUEUE_CONNECTION=database
```

2. **Setup cron job** (once):
```bash
* * * * * cd /path/to/application && php artisan schedule:run >> /dev/null 2>&1
```

The cron job executes the scheduler which:
- Automatically processes queued jobs every minute
- Runs automatic sync if enabled (see `routes/console.php`)

**No persistent worker required!** The scheduler handles everything.

## Database Schema

### Workflows Table
```sql
CREATE TABLE workflows (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT UNSIGNED NOT NULL,
    zuora_id VARCHAR(255) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    state VARCHAR(255),
    created_on TIMESTAMP,
    updated_on TIMESTAMP,
    last_synced_at TIMESTAMP,
    json_export JSON,  -- Full workflow JSON from Zuora
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_zuora_id (zuora_id),
    INDEX idx_state (state)
);
```

### Tasks Table (New)
```sql
CREATE TABLE tasks (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    workflow_id BIGINT UNSIGNED NOT NULL,
    zuora_id VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    task_type VARCHAR(255),
    object_id TEXT,
    action_type VARCHAR(255),
    call_type VARCHAR(255),
    data JSON,
    workflow_task_json JSON,  -- Original task JSON from workflow
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (workflow_id) REFERENCES workflows(id) ON DELETE CASCADE,
    INDEX idx_workflow_id (workflow_id),
    INDEX idx_zuora_id (zuora_id),
    INDEX idx_task_type (task_type)
);
```

### Job Manager Tables (Moox Jobs)
```sql
CREATE TABLE job_manager (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    job_id VARCHAR(255),
    name VARCHAR(255),
    queue VARCHAR(255),
    connection VARCHAR(255),
    status VARCHAR(255),
    created_at TIMESTAMP,
    -- ... other fields
);

CREATE TABLE failed_jobs (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    uuid VARCHAR(255) UNIQUE,
    connection TEXT,
    queue TEXT,
    payload LONGTEXT,
    exception LONGTEXT,
    failed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Sync Statistics

The `WorkflowSyncService` returns an array with:
```php
[
    'created' => 5,      // New workflows created
    'updated' => 2,      // Workflows updated
    'deleted' => 1,      // Workflows no longer in Zuora
    'total' => 8,        // Total processed
    'errors' => [],      // Array of errors (if any)
]
```

## Monitoring

### Via Moox Jobs (Filament UI)

Access Filament admin panel → Menu **Jobs**:

1. **Jobs**: View running and completed jobs
   - Job name, status, duration
   - Progress bar (if implemented)
   - Output and results

2. **Jobs Waiting**: See queued jobs
   - Execution order
   - Estimated time
   - Ability to delete pending jobs

3. **Failed Jobs**: Failure management
   - Complete error details
   - Stack trace
   - **Retry** with one click
   - **Delete** failed jobs

4. **Job Batches**: Monitor batch operations
   - Batch status
   - Jobs completed/pending/failed
   - Overall progress

### Via CLI

```bash
# Check pending jobs
php artisan queue:monitor database --max=100

# View failed jobs
php artisan queue:failed

# Retry single job
php artisan queue:retry {job-id}

# Retry all failed jobs
php artisan queue:retry all

# Delete failed jobs
php artisan queue:flush

# View scheduled tasks
php artisan schedule:list
```

### Synchronization Logs

**Location**: `storage/logs/laravel.log`

**Log Entries**:
- `'Workflow sync completed'` - Success with stats (created, updated, deleted, total)
- `'Workflow sync failed'` - Error with details and customer_id
- `'Failed to download workflow JSON'` - Warning for single workflow
- `'Cannot sync workflows: Invalid credentials'` - Credentials error

**Example log entry**:
```
[2025-12-20 12:01:30] local.INFO: Workflow sync completed
{
    "customer_id": 1,
    "stats": {
        "created": 5,
        "updated": 2,
        "deleted": 1,
        "total": 8,
        "errors": []
    }
}
```

## Microarchitecture

### Class: `WorkflowSyncService`
**Responsibility**: Synchronization orchestration
- `syncCustomerWorkflows()`: Entry point, handles Zuora API pagination
- `syncWorkflowRecord()`: Saves/updates single workflow + triggers task extraction
- `downloadWorkflowJson()`: Downloads full JSON export from Zuora
- `deleteStaleWorkflows()`: Cleanup of workflows no longer in Zuora
- `validateCustomerCredentials()`: Verifies Zuora credentials before sync

**Design Pattern**: Service Locator (injects ZuoraService via constructor injection)

**Key Flow**:
```php
foreach ($workflows as $workflowData) {
    $workflow = $this->syncWorkflowRecord($customer, $workflowData);
    $workflow->syncTasksFromJson(); // Automatic task extraction
}
```

### Class: `SyncCustomerWorkflows` (Job)
**Responsibility**: Asynchronous execution
- Implements `ShouldQueue` for background processing
- Automatic retry (3 times) with 60s backoff
- Validates customer and credentials before execution
- Decouples UI from long-running process
- Error handling with logging

**Key Features**:
```php
public int $tries = 3;
public int $backoff = 60;

public function handle(WorkflowSyncService $syncService): void {
    // Validates customer exists and has valid credentials
    // Delegates sync to WorkflowSyncService
}
```

### Model: `Workflow`
**Responsibility**: Task extraction management
- `syncTasksFromJson()`: Extracts and syncs tasks from `json_export` field
- `hasMany(Task::class)`: Relationship with tasks
- Automatically invoked after each workflow sync

**Task Extraction Logic**:
```php
public function syncTasksFromJson(): void {
    if (!$this->json_export) return;

    $tasks = $this->json_export['tasks'] ?? [];
    foreach ($tasks as $taskData) {
        Task::updateOrCreate(
            ['workflow_id' => $this->id, 'zuora_id' => $taskData['id']],
            [...] // task data
        );
    }
}
```

### Scheduled Tasks (routes/console.php)
**Responsibility**: Temporal automation (Laravel 12)
- Automatic workflow sync (optional, configurable)
- Automatic queue processing every minute (development)
- No more Kernel.php schedule method

## Testing

```php
// Unit test for the service
use App\Services\WorkflowSyncService;
use App\Models\Customer;

test('sync workflows per customer', function () {
    $customer = Customer::factory()->create();
    $service = app(WorkflowSyncService::class);

    $stats = $service->syncCustomerWorkflows($customer);

    expect($stats)->toHaveKeys(['created', 'updated', 'deleted', 'total']);
    expect($customer->workflows()->count())->toBeGreaterThan(0);
});
```

## Performance Considerations

### Implemented Optimizations

1. **API Pagination**: Default 50 items/page (configurable in `WorkflowSyncService::PAGE_SIZE`)
   - Reduces memory usage for large datasets
   - Allows progressive retrieval

2. **OAuth Token Caching**: `ZuoraService` caches token for 1 hour
   - Reduces API authentication calls
   - Cache key: `zuora_token_{hash_credentials}`

3. **Database Indexes**:
   - `workflows.customer_id` - Queries by customer
   - `workflows.zuora_id` - Fast lookup
   - `workflows.state` - Status filters
   - `tasks.workflow_id` - Task queries by workflow
   - `tasks.task_type` - Type filters

4. **Background Processing**:
   - Job queue decouples UI from sync
   - Doesn't block HTTP requests
   - Automatic retry on failure

5. **Lazy Loading**: UI uses `select()` to minimize transferred data

6. **JSON Storage**: `json_export` field enables:
   - Re-extracting tasks without API calls
   - Complete workflow backup
   - Offline analysis

### Performance Metrics

**Workflow Sync** (50 workflows):
- API calls: ~3-5 requests (depends on pagination)
- Time: ~10-30 seconds
- Memory: <128MB

**Task Extraction** (1 workflow with 20 tasks):
- Time: <1 second
- Queries: 1-20 (depends on new vs existing tasks)

### Scalability

**Supports**:
- ✅ Hundreds of customers
- ✅ Thousands of workflows per customer
- ✅ Tens of thousands of total tasks
- ✅ Parallel syncs (multi-customer via queue)

**Limitations**:
- ⚠️ Zuora API rate limit (controlled by Zuora)
- ⚠️ Database storage for JSON export (can grow)

## Rollback (if needed)

```bash
php artisan migrate:rollback
# Will revert to loading via API in the CustomerWorkflows page
```
