---
title: Deployment
description: Deploy Zuora Workflow Manager to production environments
---

# Deployment

This guide covers deploying Zuora Workflow Manager to production environments, with special focus on shared hosting environments where sudo access is not available.

## Deployment workflow

The application uses GitHub Actions for automated deployment. The workflow is defined in `.github/workflows/deploy.yml`.

### Manual deployment trigger

To deploy manually:

1. Go to the **Actions** tab in your GitHub repository
2. Select **Deploy to Production**
3. Click **Run workflow**
4. Configure the deployment options:
   - **Application Environment** - `production` or `staging`
   - **Enable Debug Mode** - `false` for production, `true` for debugging

### Deployment steps

The GitHub Actions workflow performs the following steps:

1. Checkout code from the repository
2. Setup PHP 8.4 with required extensions
3. Setup Node.js 23 for asset compilation
4. Install Composer dependencies (production mode)
5. Install Yarn dependencies
6. Build assets using Vite
7. Create `.env` file with production configuration
8. Deploy files via SCP to the production server
9. Run post-deployment commands via SSH:
   - Set correct permissions
   - Run fresh migrations
   - Clear and cache configurations
   - Link storage
   - Optimize application

## Queue worker setup

The application uses Laravel's queue system to process background jobs asynchronously. You have three options depending on your hosting environment.

### Option 1: Sync queue (simplest)

Use the sync queue driver for immediate job execution without background processing.

```env .env
QUEUE_CONNECTION=sync
```

**Pros:**
- No additional configuration required
- Jobs execute immediately with instant feedback
- Works perfectly in shared hosting environments
- No risk of queued jobs not being processed

**Cons:**
- Synchronization operations block the user's request
- May cause timeouts for long-running operations
- Not ideal for high-traffic applications

**Recommended for:** Shared hosting, development, staging, or low-traffic production sites.

### Option 2: Cron job (recommended for shared hosting)

Set up a cron job to run Laravel's scheduler every minute. The scheduler will then handle dispatching queue jobs.

**Requirements:**
- `QUEUE_CONNECTION=database` in `.env`
- Cron job access in your hosting control panel

**Add this cron job via your hosting control panel:**

```bash
* * * * * cd /path/to/app && php artisan schedule:run >> /dev/null 2>&1
```

Replace `/path/to/app` with your application path.

**What this does:**
- Runs every minute
- Executes Laravel's scheduler which dispatches background jobs
- The scheduler is configured to sync customer workflows every hour

### Option 3: Supervisor (for VPS/dedicated servers)

If you have full server access with sudo, you can set up a persistent queue worker using Supervisor.

**Requirements:**
- `QUEUE_CONNECTION=database` in `.env`
- Root/sudo access to the server
- Supervisor installed

**Install Supervisor:**

```bash
sudo apt-get install supervisor
```

**Create Supervisor configuration:**

```bash
sudo nano /etc/supervisor/conf.d/zuora-workflow-queue.conf
```

Add this configuration:

```ini
[program:zuora-workflow-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/app/artisan queue:work database --sleep=3 --tries=3 --timeout=90 --memory=256
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/log/supervisor/zuora-workflow-queue.log
stopwaitsecs=3600
```

**Start the queue worker:**

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start zuora-workflow-queue:*
```

## Environment configuration

### Required environment variables

```env .env
APP_NAME='Zuora Workflow'
APP_ENV=production
APP_KEY=base64:...
APP_DEBUG=false
APP_URL=https://your-domain.com

DB_CONNECTION=mysql
DB_HOST=...
DB_PORT=3306
DB_DATABASE=...
DB_USERNAME=...
DB_PASSWORD=...

QUEUE_CONNECTION=sync  # or 'database' depending on your choice

GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
```

### Queue configuration options

Choose the queue connection that best fits your hosting environment:

```env .env
# Use sync queue (immediate processing, no background jobs)
QUEUE_CONNECTION=sync

# Use database queue (requires cron job or Supervisor)
QUEUE_CONNECTION=database

# Use Redis (requires Redis server and cron job or Supervisor)
QUEUE_CONNECTION=redis
```

## File permissions

The deployment script sets the following permissions:

```bash
chmod -R 755 storage bootstrap/cache
chmod -R 775 storage bootstrap/cache
find storage -type f -exec chmod 664 {} \;
find bootstrap/cache -type f -exec chmod 664 {} \;
```

If you encounter permission issues, run these commands manually via SSH.

## GitHub secrets

The following secrets must be configured in your GitHub repository:

| Secret | Description |
|--------|-------------|
| `APP_KEY` | Laravel application key |
| `SSH_HOST` | Production server hostname/IP |
| `SSH_USERNAME` | SSH username |
| `SSH_PRIVATE_KEY` | SSH private key for authentication |
| `DB_HOST` | Database host |
| `DB_PORT` | Database port |
| `DB_DATABASE` | Database name |
| `DB_USERNAME` | Database username |
| `DB_PASSWORD` | Database password |
| `GOOGLE_CLIENT_ID` | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret |

## Monitoring

### Application health

After deployment, verify the application is running:

```bash
php artisan about --only=environment
```

### Queue health

Monitor queue performance (database/redis queue only):

```bash
# Check queue size
php artisan queue:monitor database --max=100

# View failed jobs
php artisan queue:failed

# Check scheduler tasks
php artisan schedule:list
```

### Logs

Monitor application logs:

```bash
# View Laravel logs
tail -f storage/logs/laravel.log

# Filter for workflow sync logs
grep -i "workflow" storage/logs/laravel.log
```

## Troubleshooting

### Queue jobs not processing

If jobs are not processing (database/redis queue only):

1. Check if cron job is running: `crontab -l`
2. Check Laravel logs: `tail -f storage/logs/laravel.log`
3. Manually run the scheduler: `php artisan schedule:run`
4. Check failed jobs: `php artisan queue:failed`

### Sync operations taking too long

If using `QUEUE_CONNECTION=sync` and experiencing timeouts:

1. Check your web server timeout settings (Apache/Nginx)
2. Consider switching to database queue with cron job
3. Reduce the frequency of scheduled syncs in `app/Console/Kernel.php`

### Migration fails

If migrations fail during deployment:

1. Check database connection in `.env`
2. Verify database credentials
3. Check database server status
4. Review migration error in deployment logs

### Permission denied errors

If you get permission denied errors:

1. SSH into your server
2. Navigate to your application directory
3. Run the permission commands manually (see File Permissions section)

## Security checklist

Before deploying to production:

- [ ] `APP_DEBUG=false` in production
- [ ] Strong `APP_KEY` generated
- [ ] Database credentials stored in GitHub Secrets
- [ ] SSH keys secured and rotated regularly
- [ ] HTTPS enabled with valid SSL certificate
- [ ] File permissions properly set
- [ ] Queue worker running (if using database queue)
- [ ] Error logs monitored regularly

## Rollback

If you need to rollback a deployment:

1. Identify the previous working commit
2. Trigger a new deployment workflow with that commit
3. Or manually SSH into the server and restore from backup

## Next steps

<CardGroup cols={2}>
  <Card title="Monitoring" icon="chart-line" href="/docs/usage#monitoring-sync-operations">
    Monitor sync operations and logs
  </Card>
  <Card title="Contributing" icon="code-branch" href="/docs/contributing">
    Contribute to the project
  </Card>
</CardGroup>
