---
title: Spatie Settings
description: Settings system implementation using Spatie Laravel Settings
---
# Spatie Laravel Settings Implementation

## Overview

This document describes the settings system implementation using the Filament Spatie Laravel Settings plugin.

## Packages Used

- `spatie/laravel-settings` v3.6.0
- `filament/spatie-laravel-settings-plugin` v4.0

## Implemented Structure

### 1. Settings Class

**File:** `app/Settings/GeneralSettings.php`

Contains the following properties:

#### Site Information
- `site_name`: Site name (string)
- `site_description`: Site description (string)

#### Maintenance
- `maintenance_mode`: Maintenance mode (boolean)

#### OAuth Configuration
- `oauth_allowed_domains`: Domains authorized for OAuth (array)
- `oauth_enabled`: Enable OAuth (boolean)
- `oauth_google_client_id`: Google OAuth Client ID (string)
- `oauth_google_client_secret`: Google OAuth Client Secret (string)
- `oauth_google_redirect_url`: OAuth redirect URL (string)

#### Admin Configuration
- `admin_default_email`: Default admin email (string)
- `admin_registration_enabled`: Enable admin registration (boolean)

#### Application Configuration
- `debug_mode`: Debug mode (boolean)
- `app_timezone`: Application timezone (string)
- `app_locale`: Application language (string)

### 2. Settings Migration

**File:** `database/settings/2025_12_22_144806_create_general_settings.php`

Default values:
- `site_name`: "Zuora Workflow"
- `site_description`: "Zuora Workflow Management"
- `maintenance_mode`: false
- `oauth_allowed_domains`: []

**File:** `database/settings/2025_12_22_152241_add_setup_fields_to_general_settings.php`

Additional values for setup sync:
- `oauth_enabled`: true
- `oauth_google_client_id`: ""
- `oauth_google_client_secret`: ""
- `oauth_google_redirect_url`: "/auth/google/callback"
- `admin_default_email`: "admin@zuora-workflow.com"
- `admin_registration_enabled`: false
- `debug_mode`: false
- `app_timezone`: "UTC"
- `app_locale`: "en"

### 3. Filament Page

**File:** `app/Filament/Pages/Settings.php`

Features:
- Accessible only to users with `super_admin` role
- Grouped in "Settings"
- Sort order: 99 (last in navigation)
- Form organized in 5 sections:
  - Site Information (2 columns)
  - Maintenance (1 column)
  - OAuth Configuration (2 columns)
  - Admin Configuration (2 columns)
  - Application Configuration (2 columns)

### 4. Configuration

**File:** `config/settings.php`

The `GeneralSettings` class is registered in the `settings` array.

## Synchronization with Existing Setup

The system has been synchronized with the existing setup that used the `AppSetting` model. A **complete migration** to Spatie Settings has been executed:

### âœ… Migration Completed

1. **AppSetting Model Removed**:
   - File `/app/Models/AppSetting.php` removed and backed up
   - Table `app_settings` no longer used

2. **OAuthService Updated**:
   - Modified to use `GeneralSettings` instead of `AppSetting`
   - Fallback to Laravel config maintained

3. **Setup Page Updated**:
   - Import changed from `App\Models\AppSetting` to `App\Settings\GeneralSettings`
   - Functionality maintained 100%

### ðŸ”„ Complete Mapping

| Setup Field | GeneralSettings Field | Sync Status |
|-------------|----------------------|-------------|
| oauth_domains | oauth_allowed_domains | âœ… **Completed** |
| (new) | oauth_enabled | âœ… **Completed** |
| (new) | oauth_google_client_id | âœ… **Completed** |
| (new) | oauth_google_client_secret | âœ… **Completed** |
| (new) | oauth_google_redirect_url | âœ… **Completed** |
| (new) | admin_default_email | âœ… **Completed** |
| (new) | admin_registration_enabled | âœ… **Completed** |
| (new) | debug_mode | âœ… **Completed** |
| (new) | app_timezone | âœ… **Completed** |
| (new) | app_locale | âœ… **Completed** |

### ðŸ§ª Test Passed

```php
// Integrity test
use App\Services\OAuthService;
use App\Settings\GeneralSettings;

$domains = OAuthService::getAllowedDomains(); // ["newdomain.com"]
$settings = app(GeneralSettings::class);
$direct = $settings->oauth_allowed_domains; // ["newdomain.com"]

// âœ… Service and Settings match: true
```

### ðŸŽ¯ Unified System

**Now the entire system exclusively uses Spatie Settings:**
- âœ… `GeneralSettings` as single source of truth
- âœ… `OAuthService` integrated with GeneralSettings
- âœ… `Setup` working with GeneralSettings
- âœ… `Settings` page with all fields
- âœ… AppSetting backup maintained

**Benefits achieved:**
- ðŸ— **Clean architecture**: Single source of truth
- ðŸ”’ **Type safety**: Strongly typed settings
- ðŸ“ **Maintainability**: Centralized interface
- ðŸš€ **Performance**: Spatie Settings built-in cache
- ðŸ”§ **Debuggability**: Better settings tracing
- ðŸ”„ **Structured migrations**: Automatic settings versioning

### Changing Settings

```php
use App\Settings\GeneralSettings;

$settings = app(GeneralSettings::class);
$settings->site_name = 'New Name';
$settings->oauth_enabled = true;
$settings->save();
```

### Admin Interface

Settings are accessible via Filament interface:
- URL: `/admin/settings`
- Required role: `super_admin`

### AppSetting Compatibility

To maintain compatibility with existing code, the `AppSetting` model remains available. However, gradual migration to direct use of `GeneralSettings` is recommended.

```php
// Old method (still working)
$domains = AppSetting::getOAuthDomains();

// New recommended method
$settings = app(GeneralSettings::class);
$domains = $settings->oauth_allowed_domains;
```

## Database

### Settings Table

The `settings` table has the following structure:

| Field | Type | Description |
|-------|------|-------------|
| group | varchar(255) | Setting group (e.g., 'general') |
| name | varchar(255) | Setting name |
| payload | longtext | Setting JSON value |
| locked | tinyint(1) | Indicates if setting is locked |
| created_at | timestamp | Creation date |
| updated_at | timestamp | Last update date |

## Adding New Settings

### 1. Extend GeneralSettings

```php
namespace App\Settings;

use Spatie\LaravelSettings\Settings;

class ExtendedSettings extends Settings
{
    public string $new_property;

    public static function group(): string
    {
        return 'general'; // or 'extended'
    }
}
```

### 2. Create Migration

```bash
lando php artisan make:settings-migration AddExtendedSettings
```

### 3. Define Default Values in Migration

```php
public function up(): void
{
    $this->migrator->add('general.new_property', 'default_value');
}
```

### 4. Register Class in config/settings.php

```php
'settings' => [
    \App\Settings\GeneralSettings::class,
    \App\Settings\ExtendedSettings::class,
],
```

## Migration from AppSetting to Spatie Settings

To completely migrate from `AppSetting` to `GeneralSettings`:

1. **Identify all settings in use**
2. **Add corresponding properties to GeneralSettings**
3. **Create migration with default values**
4. **Data migration script (optional)**:

```php
use App\Settings\GeneralSettings;
use App\Models\AppSetting;

// Execute once
$settings = app(GeneralSettings::class);
$settings->oauth_allowed_domains = AppSetting::getOAuthDomains();
$settings->admin_default_email = AppSetting::get('admin_email', 'admin@example.com');
$settings->save();
```

## Cache

To improve performance, you can enable cache in `.env` file:

```env
SETTINGS_CACHE_ENABLED=true
```

To clear settings cache:

```bash
php artisan settings:clear-cache
```

## Testing

```php
use App\Settings\GeneralSettings;

// Fake settings for tests
GeneralSettings::fake([
    'site_name' => 'Test Site',
    'oauth_enabled' => true,
    'app_locale' => 'it',
]);

// Now tests will use fake values
$settings = app(GeneralSettings::class);
echo $settings->site_name; // 'Test Site'
```

## Important Notes

1. The `settings` table already existed in the project and is being reused
2. Each change requires a migration
3. Settings are strongly typed (type-safe)
4. Page access is limited to super_admin
5. Configuration supports settings auto-discovery
6. **Backward compatibility maintained** with `AppSetting` for gradual migration
7. All setup fields are now available in settings interface

## Riferimenti

- [Documentazione Spatie Laravel Settings](https://github.com/spatie/laravel-settings)
- [Documentazione Filament Spatie Settings Plugin](https://filamentphp.com/plugins/filament-spatie-settings)
- [Documentazione Filament Forms](https://filamentphp.com/docs/forms)
