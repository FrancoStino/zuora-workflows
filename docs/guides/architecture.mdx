---
title: Architecture
description: System architecture, directory structure, and component overview
---

import { SystemArchitecture } from '@/components/system-architecture'
import { DirectoryTree } from '@/components/directory-tree'
import { ServiceCard } from '@/components/service-card'
import { ModelCard } from '@/components/model-card'
import { ERDiagram } from '@/components/er-diagram'
import { FlowDiagram } from '@/components/flow-diagram'
import { NextSteps } from '@/components/next-steps'

# Architecture

This document describes the architecture of Zuora Workflow Manager, including system design, directory structure, and key components.

## System Architecture

<SystemArchitecture />

### Component Responsibilities

<DataTable
  columns={['Component', 'Responsibility', 'Technology']}
  rows={[
    ['Filament Admin Panel', 'UI/UX for admin operations', 'Filament 4.2, Alpine.js'],
    ['Service Layer', 'Business logic and external API integration', 'PHP Classes'],
    ['Queue System', 'Background job processing', 'Laravel Queue, Redis/Database'],
    ['Models', 'Data access and relationships', 'Eloquent ORM'],
    ['Policies', 'Authorization and permissions', 'Filament Shield'],
    ['Jobs', 'Asynchronous task execution', 'Laravel Jobs'],
    ['Database', 'Data persistence', 'MariaDB, Redis']
  ]}
/>

## Directory Structure

### Application Root

<DirectoryTree
  name="zuora-workflows/"
  items={[
    { name: 'app/', type: 'folder', description: 'Application source code' },
    { name: 'bootstrap/', type: 'folder', description: 'Application bootstrap files' },
    { name: 'config/', type: 'folder', description: 'Configuration files' },
    { name: 'database/', type: 'folder', description: 'Database migrations and seeders' },
    { name: 'docs/', type: 'folder', description: 'Documentation' },
    { name: 'public/', type: 'folder', description: 'Public files and entry point' },
    { name: 'resources/', type: 'folder', description: 'Frontend resources' },
    { name: 'routes/', type: 'folder', description: 'Route definitions' },
    { name: 'storage/', type: 'folder', description: 'Storage (logs, uploads, cache)' },
    { name: 'tests/', type: 'folder', description: 'Test files' },
    { name: '.env.example', type: 'file', description: 'Environment template' },
    { name: '.lando.yml', type: 'file', description: 'Lando configuration' },
    { name: 'artisan', type: 'file', description: 'Laravel CLI tool' },
    { name: 'composer.json', type: 'file', description: 'PHP dependencies' }
  ]}
/>

### App Directory Structure

<DirectoryTree
  name="app/"
  items={[
    {
      name: 'Casts/',
      type: 'folder',
      items: [
        { name: 'EncryptedCastZuoraClientSecret.php', type: 'file', description: 'Custom cast for encrypted Zuora secrets' }
      ]
    },
    {
      name: 'Console/Commands/',
      type: 'folder',
      items: [
        { name: 'SyncWorkflows.php', type: 'file', description: 'Queue workflow sync' },
        { name: 'SyncWorkflowTasks.php', type: 'file', description: 'Re-extract tasks' }
      ]
    },
    {
      name: 'Exceptions/',
      type: 'folder',
      items: [
        { name: 'SetupException.php', type: 'file' },
        { name: 'ZuoraAuthenticationException.php', type: 'file' },
        { name: 'ZuoraException.php', type: 'file' },
        { name: 'ZuoraHttpException.php', type: 'file' }
      ]
    },
    {
      name: 'Filament/',
      type: 'folder',
      items: [
        { name: 'Concerns/', type: 'folder' },
        { name: 'Pages/', type: 'folder', items: [{ name: 'Setup.php', type: 'file', description: 'Initial setup wizard' }] },
        { name: 'Resources/', type: 'folder', items: [
          { name: 'Customers/', type: 'folder' },
          { name: 'Tasks/', type: 'folder' },
          { name: 'Users/', type: 'folder' },
          { name: 'Roles/', type: 'folder' },
          { name: 'Workflows/', type: 'folder' }
        ]},
        { name: 'Widgets/', type: 'folder' }
      ]
    },
    { name: 'Jobs/', type: 'folder', items: [{ name: 'SyncCustomersJob.php', type: 'file' }] },
    { name: 'Listeners/', type: 'folder' },
    {
      name: 'Models/',
      type: 'folder',
      items: [
        { name: 'Customer.php', type: 'file' },
        { name: 'Task.php', type: 'file' },
        { name: 'User.php', type: 'file' },
        { name: 'Workflow.php', type: 'file' }
      ]
    },
    {
      name: 'Services/',
      type: 'folder',
      items: [
        { name: 'OAuthService.php', type: 'file', description: 'OAuth handling' },
        { name: 'WorkflowSyncService.php', type: 'file', description: 'Workflow sync logic' },
        { name: 'ZuoraService.php', type: 'file', description: 'Zuora API integration' }
      ]
    },
    { name: 'Settings/', type: 'folder', items: [{ name: 'GeneralSettings.php', type: 'file' }] },
    { name: 'Support/', type: 'folder', items: [{ name: 'EncryptionHelper.php', type: 'file' }] }
  ]}
/>

## Key Components

### Service Layer

<ServiceCard
  title="ZuoraService"
  description="Handles all interactions with Zuora REST API"
  location="app/Services/ZuoraService.php"
  responsibilities={[
    'OAuth 2.0 token generation and caching (1-hour TTL)',
    'API authentication',
    'Workflow listing with pagination',
    'Workflow JSON export',
    'Error handling and HTTP exception management'
  ]}
  methods={[
    {
      name: 'getAccessToken',
      signature: 'public function getAccessToken(string $clientId, string $clientSecret, string $baseUrl): string',
      description: 'Get OAuth access token (cached)'
    },
    {
      name: 'listWorkflows',
      signature: 'public function listWorkflows(string $clientId, string $clientSecret, string $baseUrl, int $page, int $pageSize): array',
      description: 'List workflows (paginated)'
    },
    {
      name: 'downloadWorkflow',
      signature: 'public function downloadWorkflow(string $clientId, string $clientSecret, string $baseUrl, string $workflowId): array',
      description: 'Download workflow JSON'
    }
  ]}
/>

<ServiceCard
  title="WorkflowSyncService"
  description="Orchestrates workflow synchronization from Zuora"
  location="app/Services/WorkflowSyncService.php"
  responsibilities={[
    'Coordinate sync process for a customer',
    'Validate customer credentials',
    'Handle pagination',
    'Update or create workflow records',
    'Delete stale workflows',
    'Delegate task extraction to Workflow model'
  ]}
  methods={[
    {
      name: 'syncCustomerWorkflows',
      signature: 'public function syncCustomerWorkflows(Customer $customer): array',
      description: 'Sync all workflows for a customer'
    },
    {
      name: 'syncWorkflowRecord',
      signature: 'private function syncWorkflowRecord(Customer $customer, array $workflowData): array',
      description: 'Sync single workflow record'
    },
    {
      name: 'deleteStaleWorkflows',
      signature: 'private function deleteStaleWorkflows(Customer $customer, array $zuoraIds): int',
      description: 'Delete workflows not in Zuora anymore'
    }
  ]}
/>

### Models

<ModelCard
  title="Customer"
  description="Represents a customer with Zuora credentials"
  location="app/Models/Customer.php"
  properties={[
    { name: 'id', type: 'Primary Key' },
    { name: 'name', type: 'string', description: 'Customer name' },
    { name: 'zuora_client_id', type: 'string', description: 'Zuora OAuth client ID' },
    { name: 'zuora_client_secret', type: 'string', description: 'Zuora OAuth client secret (encrypted)' },
    { name: 'zuora_base_url', type: 'string', description: 'Zuora API base URL' }
  ]}
  relationships={[
    { type: 'hasMany', relation: 'workflows', description: 'Has many workflows' }
  ]}
  security="Client secret is encrypted using EncryptedCastZuoraClientSecret"
/>

<ModelCard
  title="Workflow"
  description="Represents a Zuora workflow"
  location="app/Models/Workflow.php"
  properties={[
    { name: 'id', type: 'Primary Key' },
    { name: 'customer_id', type: 'Foreign Key', description: 'Foreign key to customer' },
    { name: 'zuora_id', type: 'string', description: 'Zuora workflow ID (unique)' },
    { name: 'name', type: 'string', description: 'Workflow name' },
    { name: 'description', type: 'string', description: 'Workflow description' },
    { name: 'state', type: 'string', description: 'Workflow state' },
    { name: 'json_export', type: 'JSON', description: 'Complete workflow JSON' },
    { name: 'last_synced_at', type: 'timestamp', description: 'Last sync timestamp' }
  ]}
  relationships={[
    { type: 'belongsTo', relation: 'customer', description: 'Belongs to customer' },
    { type: 'hasMany', relation: 'tasks', description: 'Has many tasks' }
  ]}
  methods={[
    { name: 'syncTasksFromJson', signature: 'public function syncTasksFromJson(): int', description: 'Extract and sync tasks from JSON export' },
    { name: 'buildTaskAttributes', signature: 'private function buildTaskAttributes(array $taskData): array', description: 'Build task attributes from Zuora JSON' }
  ]}
/>

<ModelCard
  title="Task"
  description="Represents a task within a workflow"
  location="app/Models/Task.php"
  properties={[
    { name: 'id', type: 'Primary Key' },
    { name: 'workflow_id', type: 'Foreign Key', description: 'Foreign key to workflow' },
    { name: 'task_id', type: 'string', description: 'Zuora task ID' },
    { name: 'name', type: 'string', description: 'Task name' },
    { name: 'action_type', type: 'string', description: 'Type of action (Email, Export, etc.)' },
    { name: 'object', type: 'string', description: 'Zuora object type' },
    { name: 'priority', type: 'string', description: 'Task priority' },
    { name: 'state', type: 'string', description: 'Task state' },
    { name: 'parameters', type: 'JSON', description: 'Task parameters' }
  ]}
  relationships={[
    { type: 'belongsTo', relation: 'workflow', description: 'Belongs to workflow' }
  ]}
/>

## Database Schema

### Entity Relationship Diagram

<ERDiagram />

### Tables Overview

<DataTable
  columns={['Table', 'Purpose', 'Key Fields']}
  rows={[
    ['users', 'User accounts', 'id, name, email, password'],
    ['roles', 'User roles', 'id, name, guard_name'],
    ['permissions', 'Granular permissions', 'id, name, guard_name'],
    ['model_has_roles', 'User-role assignments', 'role_id, model_id, model_type'],
    ['customers', 'Customer data', 'name, zuora_client_id, zuora_client_secret'],
    ['workflows', 'Workflow data', 'customer_id, zuora_id, name, json_export'],
    ['tasks', 'Workflow tasks', 'workflow_id, task_id, name, action_type'],
    ['settings', 'Application settings', 'group, name, payload'],
    ['jobs', 'Queue jobs', 'queue, payload, attempts'],
    ['failed_jobs', 'Failed jobs', 'connection, queue, payload, exception']
  ]}
/>

## Flow Diagrams

### Workflow Synchronization Flow

<FlowDiagram
  type="workflow-sync"
  title="Workflow Synchronization Flow"
/>

### Authentication Flow

<FlowDiagram
  type="authentication"
  title="Authentication Flow"
/>

## Security Architecture

### Encryption Strategy

<Steps steps={[
  'Zuora Client Secrets - Encrypted at rest using EncryptedCastZuoraClientSecret',
  'OAuth Secrets - Encrypted using EncryptedCastGoogleClientSecret',
  'User Passwords - Hashed with Bcrypt',
  'API Tokens - Sanctum tokens for API authentication'
]} />

### Access Control

<Steps steps={[
  'Authentication - Laravel Auth + Socialite for OAuth',
  'Authorization - Filament Shield (Spatie Laravel Permissions)',
  'Policies - Model-level authorization',
  'Middleware - Route-level protection'
]} />

## Performance Considerations

### Caching Strategy

<InfoCards
  cards={[
    { title: 'Zuora Access Tokens', description: 'Cached for 1 hour (Redis/file cache)' },
    { title: 'Settings', description: 'Optional caching (disabled by default in dev)' },
    { title: 'Filament Cache', description: 'Panel configuration cache' },
    { title: 'Query Optimization', description: 'Database indexes on foreign keys' }
  ]}
/>

### Queue Configuration

<DataTable
  columns={['Environment', 'Queue Driver', 'Description']}
  rows={[
    ['Development', 'sync', 'Immediate processing (no queue worker needed)'],
    ['Development', 'database', 'Queue worker required (easier debugging)'],
    ['Production', 'redis', 'Recommended for performance and scalability']
  ]}
/>

<Alert type="info">
  <strong>Retry Logic:</strong> 3 attempts with 60s exponential backoff
</Alert>

<NextSteps
  links={[
    { title: 'Features Guide', href: './features', description: 'Learn about available features' },
    { title: 'API Reference', href: '../reference/api', description: 'API endpoints and usage' },
    { title: 'Development Guide', href: './development', description: 'Development workflow' }
  ]}
/>

## Related Documentation

<LinksGrid
  links={[
    { title: 'Laravel Architecture', url: 'https://laravel.com/docs/12.x/architecture-concepts', icon: 'ðŸ“š' },
    { title: 'Filament Architecture', url: 'https://filamentphp.com/docs/4.x/panels/architecture', icon: 'ðŸŽ¨' },
    { title: 'Spatie Laravel Settings', url: 'https://spatie.be/docs/laravel-settings', icon: 'âš™ï¸' }
  ]}
/>
