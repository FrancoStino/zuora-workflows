name: Create Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Enforce master branch
        if: github.ref != 'refs/heads/master'
        run: |
          echo "âŒ This workflow can only be run from the master branch."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semver
        run: npm install -g semver

      - name: Calculate new version
        id: version
        run: |
          # Get current version from composer.json
          CURRENT_VERSION=$(jq -r '.version' composer.json)
          echo "Current version: $CURRENT_VERSION"
          
          # Calculate new version using semver
          NEW_VERSION=$(semver -i ${{ github.event.inputs.version_type }} $CURRENT_VERSION)
          echo "New version: $NEW_VERSION"
          
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update composer.json
        run: |
          jq --arg version "${{ steps.version.outputs.new }}" '.version = $version' composer.json > composer.tmp.json
          mv composer.tmp.json composer.json
          echo "âœ… Updated composer.json to version ${{ steps.version.outputs.new }}"

      - name: Generate changelog
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-file: 'CHANGELOG.md'
          release-count: 0
          skip-version-file: true
          skip-commit: true
          skip-git-pull: true
          version: ${{ steps.version.outputs.new }}
          tag-prefix: 'v'
          preset: 'angular'

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add composer.json CHANGELOG.md
          git commit -m "chore(release): v${{ steps.version.outputs.new }}"
          git push origin master
          echo "âœ… Committed and pushed version bump"

      - name: Create and push tag
        run: |
          git tag "${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
          echo "âœ… Created and pushed tag ${{ steps.version.outputs.tag }}"

      - name: Verify changes
        run: |
          echo "ğŸ“„ composer.json version:"
          jq -r .version composer.json
          echo ""
          echo "ğŸ“„ CHANGELOG.md preview:"
          head -n 10 CHANGELOG.md
          echo ""
          echo "ğŸ·ï¸ Git tags:"
          git tag -l "v*" | tail -n 5

      - name: Create release artifact
        run: |
          zip -r release.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x "tests/*" \
            -x ".env*" \
            -x "*.log"
          echo "âœ… Release artifact created"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: Release ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.clean_changelog }}
          draft: false
          prerelease: false

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release.zip
          asset_name: source-code.zip
          asset_content_type: application/zip

      - name: Release completed
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.tag }} completed successfully!"
          echo "ğŸ“¦ Version: ${{ steps.version.outputs.current }} â†’ ${{ steps.version.outputs.new }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
